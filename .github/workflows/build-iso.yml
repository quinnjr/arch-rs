name: Build and Release ArchLinux ISO

on:
  push:
    tags:
      - '20*.*.*'  # Trigger on date tags like 2025.11.27 (YYYY.MM.DD format)
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version tag in YYYY.MM.DD format (e.g., 2025.11.27)'
        required: true
        default: '2025.11.27'

env:
  ISO_NAME: arch-rs

jobs:
  build-iso:
    name: Build ArchLinux ISO with Rust Utilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (e.g., 2025.11.27)
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Build ISO in Docker container
        run: |
          docker run --rm \
            --privileged \
            -v "${{ github.workspace }}":/workspace:rw \
            -w /workspace \
            archlinux:latest \
            bash -c "
              set -e
              # Update system
              pacman -Syu --noconfirm

              # Install dependencies
              pacman -S --noconfirm archiso git reflector

              # Update mirrorlist for better reliability
              echo \"Updating mirrorlist for better reliability...\"
              # Try downloading official mirrorlist first (most reliable)
              curl -s 'https://archlinux.org/mirrorlist/?country=US&country=DE&country=NL&protocol=https&ip_version=4&use_mirror_status=on' | sed 's/^#Server/Server/' > /etc/pacman.d/mirrorlist 2>/dev/null && echo \"Official mirrorlist downloaded\" || {
                echo 'Official mirrorlist download failed, trying reflector...'
                # Try reflector with multiple countries
                reflector --country 'United States,Germany,Netherlands' --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist 2>/dev/null && echo \"Reflector updated mirrorlist\" || {
                  echo 'Reflector failed, using hardcoded reliable mirrors...'
                  # Use known working mirrors - download from official source
                  curl -s 'https://archlinux.org/mirrorlist/all/https/' | sed 's/^#Server/Server/' | head -20 > /etc/pacman.d/mirrorlist 2>/dev/null || {
                    # Last resort: hardcoded mirrors
                    printf '%s\n' \
                      '## Arch Linux repository mirrorlist' \
                      '## Generated for CI/CD build' \
                      '' \
                      '## United States' \
                      'Server = https://mirror.rackspace.com/archlinux/$$repo/os/$$arch' \
                      'Server = https://geo.mirror.pkgbuild.com/$$repo/os/$$arch' \
                      'Server = https://mirror.fcix.net/archlinux/$$repo/os/$$arch' \
                      '' \
                      '## Europe (backup)' \
                      'Server = https://mirror.selfnet.de/archlinux/$$repo/os/$$arch' \
                      'Server = https://archlinux.mirror.liteserver.nl/$$repo/os/$$arch' \
                      'Server = https://mirror.ams1.nl.leaseweb.net/archlinux/$$repo/os/$$arch' \
                      > /etc/pacman.d/mirrorlist
                  }
                }
              }
              echo \"Mirrorlist updated\"
              echo \"First few mirrors:\"
              head -5 /etc/pacman.d/mirrorlist

              # Make scripts executable
              chmod +x build.sh profile/airootfs/root/*.sh scripts/*.sh 2>/dev/null || true

              # Verify profile structure
              echo \"Verifying profile structure...\"
              if [ ! -f profile/profiledef.sh ]; then
                echo \"ERROR: profile/profiledef.sh not found\"
                exit 1
              fi
              if [ ! -f profile/packages.x86_64 ]; then
                echo \"ERROR: profile/packages.x86_64 not found\"
                exit 1
              fi
              echo \"Profile structure verified\"

              # Build ISO
              ./build.sh --clean

              # Find ISO and rename it
              ISO_FILE=\$(find out -name '*.iso' -type f | head -1)
              if [ -z \"\$ISO_FILE\" ]; then
                echo \"ERROR: No ISO file found in out/ directory\"
                ls -la out/ || true
                exit 1
              fi

              ISO_DIR=\$(dirname \"\$ISO_FILE\")
              NEW_NAME=\"${ISO_NAME}-${{ steps.version.outputs.version }}.iso\"
              NEW_PATH=\"\$ISO_DIR/\$NEW_NAME\"

              cp \"\$ISO_FILE\" \"\$NEW_PATH\"
              # Ensure file is readable/writable by host user (GitHub Actions runner)
              chmod 666 \"\$NEW_PATH\" 2>/dev/null || true
              echo \"ISO built: \$NEW_PATH\"
              ls -lh \"\$NEW_PATH\"
            "

      - name: Find and prepare ISO
        id: iso
        run: |
          # Find the ISO file - first try versioned name
          EXPECTED_NAME="${ISO_NAME}-${{ steps.version.outputs.version }}.iso"
          ISO_FILE=$(find out -name "$EXPECTED_NAME" -type f | head -1)

          # Fallback to any ISO if versioned one not found
          if [ -z "$ISO_FILE" ]; then
            ISO_FILE=$(find out -name '*.iso' -type f | head -1)
            if [ -n "$ISO_FILE" ]; then
              # Check if it already has the version in the name
              CURRENT_NAME=$(basename "$ISO_FILE")
              if [[ "$CURRENT_NAME" != "$EXPECTED_NAME" ]]; then
                # Rename to versioned name
                ISO_DIR=$(dirname "$ISO_FILE")
                NEW_PATH="$ISO_DIR/$EXPECTED_NAME"
                # Ensure we have write permissions (file may be owned by root from Docker)
                sudo chmod 666 "$ISO_FILE" 2>/dev/null || chmod 666 "$ISO_FILE" 2>/dev/null || true
                cp "$ISO_FILE" "$NEW_PATH"
                sudo chmod 644 "$NEW_PATH" 2>/dev/null || chmod 644 "$NEW_PATH" 2>/dev/null || true
                ISO_FILE="$NEW_PATH"
              fi
            fi
          fi

          if [ -z "$ISO_FILE" ]; then
            echo "ERROR: No ISO file found!"
            ls -la out/ || true
            exit 1
          fi

          # Ensure readable permissions (file may be owned by root from Docker)
          sudo chmod 644 "$ISO_FILE" 2>/dev/null || chmod 644 "$ISO_FILE" 2>/dev/null || true

          FINAL_NAME=$(basename "$ISO_FILE")
          echo "path=${ISO_FILE}" >> $GITHUB_OUTPUT
          echo "name=${FINAL_NAME}" >> $GITHUB_OUTPUT
          echo "ISO found: ${ISO_FILE}"
          ls -lh "${ISO_FILE}"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-rs-iso-${{ steps.version.outputs.version }}
          path: ${{ steps.iso.outputs.path }}
          retention-days: 30

      - name: Get ISO size and checksums
        id: checksums
        run: |
          if [ -f "${{ steps.iso.outputs.path }}" ]; then
            ISO_SIZE=$(du -h "${{ steps.iso.outputs.path }}" | cut -f1)
            SHA256=$(sha256sum "${{ steps.iso.outputs.path }}" | cut -d' ' -f1)
            MD5=$(md5sum "${{ steps.iso.outputs.path }}" | cut -d' ' -f1)

            echo "size=${ISO_SIZE}" >> $GITHUB_OUTPUT
            echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
            echo "md5=${MD5}" >> $GITHUB_OUTPUT

            echo "ISO Size: ${ISO_SIZE}"
            echo "SHA256: ${SHA256}"
            echo "MD5: ${MD5}"
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ArchLinux ISO with Rust Utilities ${{ steps.version.outputs.version }}
          body: |
            ## ArchLinux ISO with Rust-Based Utilities

            **Version:** ${{ steps.version.outputs.version }}
            **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            **Commit:** ${{ github.sha }}

            ### ISO Information
            - **File:** ${{ steps.iso.outputs.name }}
            - **Size:** ${{ steps.checksums.outputs.size }}
            - **SHA256:** `${{ steps.checksums.outputs.sha256 }}`
            - **MD5:** `${{ steps.checksums.outputs.md5 }}`

            ### What's Included
            This ISO replaces GNU core utilities with Rust-based alternatives:
            - **uutils-coreutils** - Complete coreutils replacement
            - **ripgrep (rg)** - Fast grep replacement
            - **fd** - Fast find replacement
            - **bat** - cat with syntax highlighting
            - **eza** - Modern ls replacement
            - **procs** - Modern ps replacement
            - **bottom (btm)** - System monitor
            - **dust** - du replacement
            - **zoxide** - Smart cd replacement
            - **starship** - Cross-shell prompt
            - **tealdeer (tldr)** - Simplified man pages
            - **sd** - Intuitive sed replacement
            - **tokei** - Code statistics
            - **hyperfine** - Benchmarking tool

            ### Installation
            See [INSTALL.md](https://github.com/${{ github.repository }}/blob/main/INSTALL.md) for installation instructions.

            ### Verification
            ```bash
            # Verify SHA256 checksum
            echo "${{ steps.checksums.outputs.sha256 }}" | sha256sum -c

            # Verify MD5 checksum
            echo "${{ steps.checksums.outputs.md5 }}" | md5sum -c
            ```
          files: ${{ steps.iso.outputs.path }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ISO built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${{ steps.iso.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ steps.checksums.outputs.size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256:** \`${{ steps.checksums.outputs.sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**MD5:** \`${{ steps.checksums.outputs.md5 }}\`" >> $GITHUB_STEP_SUMMARY

