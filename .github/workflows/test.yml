name: Test Build System

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run build system unit tests
        id: unit-tests
        run: |
          chmod +x tests/build.test.sh
          bash tests/build.test.sh
        continue-on-error: false

      - name: Test Results Summary
        if: always()
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.unit-tests.outcome }}" == "success" ]; then
            echo "‚úÖ All unit tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some unit tests failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi

  validation:
    name: Validation & Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: |
          chmod +x build.sh
          chmod +x tests/build.test.sh
          chmod +x profile/airootfs/root/*.sh
          chmod +x scripts/*.sh 2>/dev/null || true

      - name: Validate script syntax
        id: syntax
        run: |
          echo "Validating bash script syntax..."
          FAILED=0
          SCRIPT_COUNT=0

          # Use find with -print0 and handle empty results robustly
          while IFS= read -r -d '' script || [ -n "$script" ]; do
            if [ -n "$script" ]; then
              SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
              echo "Checking: $script"
              if ! bash -n "$script" 2>&1; then
                echo "‚ùå Syntax error in: $script"
                FAILED=1
              else
                echo "‚úÖ $script"
              fi
            fi
          done < <(find . -name "*.sh" -type f ! -path "./.git/*" ! -path "./work/*" ! -path "./out/*" ! -path "./build/*" -print0 2>/dev/null || true)

          if [ $SCRIPT_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è  No shell scripts found to validate"
          fi

          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ All scripts have valid syntax"

      - name: Check required files
        id: files
        run: |
          echo "Checking required files..."
          REQUIRED_FILES=(
            "build.sh"
            "profile/packages.x86_64"
            "profile/pacman.conf"
            "profile/profiledef.sh"
            "profile/airootfs/root/customize_airootfs.sh"
            "profile/airootfs/root/post-install.sh"
            "profile/airootfs/root/.automated_script.sh"
            "profile/airootfs/root/install-helper.sh"
          )

          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Required file missing: $file"
              MISSING=1
            else
              echo "‚úÖ $file"
            fi
          done

          if [ $MISSING -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ All required files present"

      - name: Validate package configuration
        id: packages
        run: |
          echo "Validating package configuration..."

          # Check that uutils-coreutils is in packages list
          if ! grep -q "uutils-coreutils" profile/packages.x86_64; then
            echo "‚ùå uutils-coreutils not found in packages.x86_64"
            exit 1
          fi
          echo "‚úÖ uutils-coreutils in package list"

          # Check that GNU coreutils is NOT in packages list
          if grep -q "^coreutils$" profile/packages.x86_64; then
            echo "‚ùå GNU coreutils should not be in packages.x86_64"
            exit 1
          fi
          echo "‚úÖ GNU coreutils not in package list"

          # Check that all Rust utilities are listed
          RUST_UTILS=("ripgrep" "fd" "bat" "eza" "procs" "bottom" "dust" "zoxide" "starship" "tealdeer" "sd" "tokei" "hyperfine")
          MISSING_UTILS=0
          for util in "${RUST_UTILS[@]}"; do
            if ! grep -q "^${util}" profile/packages.x86_64; then
              echo "‚ö†Ô∏è  Warning: $util not found in packages.x86_64"
              MISSING_UTILS=1
            fi
          done

          if [ $MISSING_UTILS -eq 1 ]; then
            echo "‚ö†Ô∏è  Some Rust utilities may be missing from package list"
          else
            echo "‚úÖ All Rust utilities in package list"
          fi

      - name: Validate profiledef.sh
        id: profiledef
        run: |
          echo "Validating profiledef.sh..."

          # Check that pacman_packages_exclude is empty or commented out
          # We allow GNU utilities during build and remove them in customize_airootfs.sh
          if grep -A 5 "pacman_packages_exclude=(" profile/profiledef.sh | grep -qE "^[[:space:]]*coreutils"; then
            echo "‚ö†Ô∏è  Warning: coreutils in pacman_packages_exclude (should be empty/commented)"
          else
            echo "‚úÖ pacman_packages_exclude is empty/commented (correct - allows build)"
          fi

      - name: Validate pacman.conf
        id: pacman-conf
        run: |
          echo "Validating pacman.conf..."

          # Check that IgnorePkg is commented out or not present
          # We allow GNU utilities during build and remove them in customize_airootfs.sh
          if grep -q "^IgnorePkg.*coreutils" profile/pacman.conf; then
            echo "‚ö†Ô∏è  Warning: IgnorePkg contains coreutils (should be commented out)"
            echo "   This prevents package installation. GNU utilities are removed in customize_airootfs.sh instead."
          else
            echo "‚úÖ IgnorePkg is commented out or not present (correct - allows build)"
          fi

          # Verify that customize_airootfs.sh handles GNU utility removal
          if grep -q "Removing GNU utilities" profile/airootfs/root/customize_airootfs.sh; then
            echo "‚úÖ customize_airootfs.sh handles GNU utility removal"
          else
            echo "‚ö†Ô∏è  Warning: customize_airootfs.sh may not handle GNU utility removal"
          fi

      - name: Check script permissions
        id: permissions
        run: |
          echo "Checking script permissions..."
          SCRIPTS=(
            "build.sh"
            "profile/airootfs/root/customize_airootfs.sh"
            "profile/airootfs/root/post-install.sh"
            "profile/airootfs/root/.automated_script.sh"
            "profile/airootfs/root/install-helper.sh"
            "tests/build.test.sh"
          )

          FAILED=0
          for script in "${SCRIPTS[@]}"; do
            if [ ! -x "$script" ]; then
              echo "‚ùå Script not executable: $script"
              FAILED=1
            else
              echo "‚úÖ $script is executable"
            fi
          done

          if [ $FAILED -eq 1 ]; then
            exit 1
          fi

      - name: Validate aliases configuration
        id: aliases
        run: |
          echo "Validating Rust utility aliases..."

          # Check that rust-utils.sh is created in customize script
          if ! grep -q "rust-utils.sh" profile/airootfs/root/customize_airootfs.sh; then
            echo "‚ùå rust-utils.sh not created in customize_airootfs.sh"
            exit 1
          fi
          echo "‚úÖ rust-utils.sh configured"

          # Check that eza is aliased to ls
          if grep "alias ls=" profile/airootfs/root/customize_airootfs.sh | grep -q "eza"; then
            echo "‚úÖ eza aliased to ls"
          else
            echo "‚ö†Ô∏è  Warning: eza may not be aliased to ls"
          fi

          # Check that wrapper scripts are created
          if ! grep -q "create_rust_wrapper.*ls.*eza" profile/airootfs/root/customize_airootfs.sh; then
            echo "‚ö†Ô∏è  Warning: ls wrapper for eza may not be created"
          else
            echo "‚úÖ ls wrapper for eza configured"
          fi

      - name: Validation Summary
        if: always()
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Script Syntax | ${{ steps.syntax.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Required Files | ${{ steps.files.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Config | ${{ steps.packages.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| profiledef.sh | ${{ steps.profiledef.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| pacman.conf | ${{ steps.pacman-conf.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Script Permissions | ${{ steps.permissions.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Aliases Config | ${{ steps.aliases.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, validation]
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test build script dry-run
        run: |
          echo "Testing build script structure..."

          # Check that build.sh exists and is executable
          if [ ! -x "build.sh" ]; then
            echo "‚ùå build.sh is not executable"
            exit 1
          fi

          # Check that build.sh has required functions
          if ! grep -q "log_info\|log_error" build.sh; then
            echo "‚ö†Ô∏è  Warning: build.sh may be missing logging functions"
          fi

          # Check that build.sh checks for root
          if ! grep -q "EUID\|root" build.sh; then
            echo "‚ö†Ô∏è  Warning: build.sh may not check for root privileges"
          fi

          echo "‚úÖ Build script structure validated"

      - name: Test profile structure
        run: |
          echo "Testing profile structure..."

          # Check profile directory structure
          PROFILE_DIRS=(
            "profile"
            "profile/airootfs"
            "profile/airootfs/etc"
            "profile/airootfs/root"
            "profile/efiboot"
            "profile/syslinux"
          )

          for dir in "${PROFILE_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå Directory missing: $dir"
              exit 1
            fi
          done
          echo "‚úÖ Profile directory structure valid"

      - name: Test configuration consistency
        run: |
          echo "Testing configuration consistency..."

          # Check that pacman_packages_exclude is empty (we allow GNU utilities during build)
          EXCLUDED_PROFILEDEF=$(grep -A 10 "pacman_packages_exclude=(" profile/profiledef.sh | grep -oE '[a-z-]+' | grep -v "pacman_packages_exclude" | grep -v "^$" | sort)
          
          # Check that IgnorePkg is commented out (we allow GNU utilities during build)
          EXCLUDED_PACMAN=$(grep "^IgnorePkg" profile/pacman.conf | grep -oE '[a-z-]+' | grep -v "IgnorePkg" | sort)

          echo "Excluded in profiledef.sh: ${EXCLUDED_PROFILEDEF:-<empty>}"
          echo "Excluded in pacman.conf (active): ${EXCLUDED_PACMAN:-<empty>}"

          # Our approach: Both should be empty/commented because we:
          # 1. Allow GNU utilities during build (they're required dependencies)
          # 2. Remove them in customize_airootfs.sh after installation
          # 3. Configure IgnorePkg in the installed system (not in the build profile)
          
          if [ -n "$EXCLUDED_PROFILEDEF" ]; then
            echo "‚ùå Error: pacman_packages_exclude should be empty (GNU utilities removed in customize_airootfs.sh)"
            exit 1
          fi
          
          if [ -n "$EXCLUDED_PACMAN" ]; then
            echo "‚ùå Error: IgnorePkg should be commented out in profile/pacman.conf (prevents package installation)"
            exit 1
          fi
          
          # Verify that customize_airootfs.sh handles GNU utility removal
          if ! grep -q "Removing GNU utilities" profile/airootfs/root/customize_airootfs.sh; then
            echo "‚ùå Error: customize_airootfs.sh should handle GNU utility removal"
            exit 1
          fi
          
          echo "‚úÖ Configuration is consistent:"
          echo "   - pacman_packages_exclude is empty (allows build)"
          echo "   - IgnorePkg is commented out (allows build)"
          echo "   - GNU utilities are removed in customize_airootfs.sh"

      - name: Integration Test Summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Integration tests completed" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, validation, integration-tests]
    if: always()
    defaults:
      run:
        shell: bash

    steps:
      - name: Overall Test Summary
        run: |
          echo "## üß™ Overall Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validation.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests.result }}" == "success" ] && \
             [ "${{ needs.validation.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "üéâ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  Some tests failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          fi

